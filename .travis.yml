language: go

service:
  - docker

go:
   - "1.14.x"

os:
  - linux

services:
  - docker

branches:
  only:
    - master
    - /^release-[0-9]+\..*$/

addons:
  sonarcloud:
    organization: "open-cluster-management"
    token:
      secure: "XRzwDRgL26Ym7K84PfpI853UQ+JGTc+Cjq2QygvxLfUprfsmq670H/9j2CExtKRXvJBnxeZGjMqo3EbXKFRmh9rGi/foom11aItPsXw4MzxRLXNkBxyazc+B7WhoFUChUE1/ZIkEmmy5R5wIuqj9FTN42IKM6Rv7ypDptg3KKstqyRugCWYlkmHIM+nPGMasQHBadNaSUJy0H/Tf+dw04gOUYiEhqzV0oL3SITRo2REamFebZroDy/GzpYzHAjtquWoU5dCu6+egMk1KkT/WJzGLWOHvd6CnHMGKarNM3ZDgzZIa1JaTGECxIu/Tvi2DkUEsJUQIFmzsPYRhYEOBE9afEbiTf7AdLBl3RFIxGf3+ThWTPjDmv6V1/ePr4SlGRuRO9+V8dHos42IxR7vwRgwGbE6MQlEZBHiD7VQTVtpVxhjL1s1TbmEAnib6mmdb7klf2o4Iw/m75loDFZMrFd03pXDSi1EPkwJW4VONiujRS2FAcIAwz2l/H6KWiVH1136ga3CzK+D1YFso38AmEwD7p3DVWs9PdXIxCuzU4kRpMEF2zFhqnfIWslSg1yvMI9NApdP+l+FTC6IwVwb52vZxfH0uKM5pR3LiCjy64weIokOlSwbVZFEogDzZob9y285C8SpXZA5+DG92e3FdWMltj2dDeV+n1I82layjI/I="
  
env:
  global:
    # Required
    - OS=linux
    - COMPONENT_TAG_EXTENSION="-${TRAVIS_COMMIT}"
    # Component Specific
    - COMPONENT_TYPE="make"
    - COMPONENT_INIT_COMMAND=${TRAVIS_BUILD_DIR}/build/install-dependencies.sh
    - COMPONENT_BUILD_COMMAND=${TRAVIS_BUILD_DIR}/build/build.sh
    - COMPONENT_UNIT_TEST_COMMAND=${TRAVIS_BUILD_DIR}/build/run-unit-tests.sh
    - COMPONENT_E2E_TEST_COMMAND=${TRAVIS_BUILD_DIR}/build/run-e2e-tests.sh

before_install:
  - ./build/install-dependencies.sh
  - export ISHIELD_REPO_ROOT=$TRAVIS_BUILD_DIR

stages:
  - lint
  - build
  - test-unit
  - test-e2e
  - publish

jobs:
  include:
    - stage: lint
      name: "Run code lint"
      script:
         - |
           make lint
    - stage: build
      name: "Build the image and push it"
      script:
         - |
           make init
           make component/build
           make sec-scan
    - stage: test-unit
      name: "Run unit test"
      script:
        - set -e
        - |
          make init
          make component/test/unit
          make sonar-go-test-ishield
          make sonar-go-test-op
          # make sonar/go enable it after resolving package references to upstream repo
    - stage: test-e2e
      name: "Deploy the image to a cluster and run e2e tests"
      script:
        - |
          make init
          make component/pull
          make component/test/e2e
    - stage: publish
      name: "Publish the image to quay with an official version/sha tag and publish entry to integration pipeline stage"
      if: env(ENABLE_PUBLISH) = true AND branch = master
      #type = push AND branch = master
      script:
        - |
          make init
          make component/build
          make publish
          #${TRAVIS_BUILD_DIR}/build/pipeline.sh
