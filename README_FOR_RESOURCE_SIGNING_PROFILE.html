
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Define Protected Resources Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="style.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="README_SIGNER_CONFIG.html" />
    
    
    <link rel="prev" href="README_QUICK.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="README_OVERVIEW.html">
            
                <a href="README_OVERVIEW.html">
            
                    
                    Overview
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="README_QUICK.html">
            
                <a href="README_QUICK.html">
            
                    
                    Quick Start
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.4" data-path="README_FOR_RESOURCE_SIGNING_PROFILE.html">
            
                <a href="README_FOR_RESOURCE_SIGNING_PROFILE.html">
            
                    
                    Define Protected Resources
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="README_SIGNER_CONFIG.html">
            
                <a href="README_SIGNER_CONFIG.html">
            
                    
                    Signer Configuration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="README_RESOURCE_SIGNATURE.html">
            
                <a href="README_RESOURCE_SIGNATURE.html">
            
                    
                    How to Sign Resources
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="README_SECURITY.html">
            
                <a href="README_SECURITY.html">
            
                    
                    Security
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="README_ISHIELD_OPERATOR_CR.html">
            
                <a href="README_ISHIELD_OPERATOR_CR.html">
            
                    
                    Integrity Shield Custom Resource
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="README_DEPLOY_ISHIELD_LOCAL.html">
            
                <a href="README_DEPLOY_ISHIELD_LOCAL.html">
            
                    
                    Deploy Integrity Shield on Minikube
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="README_DEVELOPMENT.html">
            
                <a href="README_DEVELOPMENT.html">
            
                    
                    Development
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.11" data-path="README_DEMO.html">
            
                <a href="README_DEMO.html">
            
                    
                    Demo
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >Define Protected Resources</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="define-protected-resources">Define Protected Resources</h1>
<h2 id="create-resource-signing-profile">Create Resource Signing Profile</h2>
<p>You can define which resources should be protected with signature by Integrity Shield.
For resources in a namespace, custom resource <code>ResourceSigningProfile</code> (RSP) is created in the same namespace.
The example below shows a definition to protect ConfigMap and Service resource in <code>secure-ns</code> namespace.</p>
<pre><code class="lang-yaml"><span class="hljs-attr">apiVersion:</span> apis.integrityshield.io/v1alpha1
<span class="hljs-attr">kind:</span> ResourceSigningProfile
<span class="hljs-attr">metadata:</span>
<span class="hljs-attr">  name:</span> sample-rsp
<span class="hljs-attr">  namespace:</span> secure-ns
<span class="hljs-attr">spec:</span>
<span class="hljs-attr">  protectRules:</span>
<span class="hljs-attr">  - match:</span>
<span class="hljs-attr">    - kind:</span> ConfigMap
<span class="hljs-attr">    - kind:</span> Service
</code></pre>
<p>You can create these resource by</p>
<pre><code>oc apply -f sample-rsp.yaml -n secure-ns
</code></pre><p>This profile become available instantly after creation, and any further incoming admission requests that match this profile will be evaluated by signature verification in IShield.</p>
<h2 id="rule-syntax">Rule Syntax</h2>
<p>You can list rules to define protect resources.
Rule has <code>match</code> and <code>exclude</code> fields.
The rules can be defined with the fields <code>name, operation, apiVersion, apiGroup, kind, username</code>.
In each field, values can be listed with &quot;<strong>,</strong>&quot; and &quot;<strong>*</strong>&quot; can be used as a wildcard.</p>
<p>If you want to exclude some resources from matched resources, you can set rules in <code>exclude</code> field.</p>
<p>For example, the rule below covers any ConfigMap except name <code>unprotected-cm</code> and any resources in apiGroup <code>rbac.authorization.k8s.io</code> in the same namespace.</p>
<pre><code class="lang-yaml"><span class="hljs-attr">protectRules:</span>
<span class="hljs-attr">- match:</span>
<span class="hljs-attr">  - kind:</span> ConfigMap
<span class="hljs-attr">  exclude:</span>
<span class="hljs-attr">  - kind:</span> ConfigMap
<span class="hljs-attr">    name:</span> unprotected-cm
<span class="hljs-attr">- match:</span>
<span class="hljs-attr">  - apiGroup:</span> rbac.authorization.k8s.io
</code></pre>
<p>Another example below is the rule covers any resources in the same namespace.</p>
<pre><code class="lang-yaml"><span class="hljs-attr">protectRules:</span>
<span class="hljs-attr">- match:</span>
<span class="hljs-attr">  - kind:</span> <span class="hljs-string">&quot;*&quot;</span>
</code></pre>
<h2 id="define-allow-patterns">Define allow patterns</h2>
<p>The resources covered by the rule above cannot be created/updated without signature, but you may want to define cases for allowing requests in certain situations.</p>
<p>You can use <code>ignoreRules</code> to define a condition for allowing some requests that match this rule.
For example, by the below RSP, all namespaced requests are protected in this namespace, but only requests by <code>secure-operator</code> ServiceAccount is allowed without signature.</p>
<pre><code class="lang-yaml"><span class="hljs-attr">protectRules:</span>
<span class="hljs-attr">- match:</span>
<span class="hljs-attr">  - kind:</span> <span class="hljs-string">&quot;*&quot;</span>
<span class="hljs-attr">ignoreRules:</span>
<span class="hljs-attr">- match:</span>
<span class="hljs-attr">  - username:</span> <span class="hljs-string">&quot;system:serviceaccount:secure-ns:secure-operator&quot;</span>
</code></pre>
<h2 id="define-force-check-patterns-override-allow-pattern">Define force check patterns (override allow pattern)</h2>
<p>You can also set rules to override allow patterns.
For example, the following RSP will protect all requests in the namespace except ones by <code>secure-operator</code> ServiceAccount, but only the requests that are Secret kind will be protected with signature because it is specified in <code>forceCheckRules</code>.</p>
<pre><code class="lang-yaml"><span class="hljs-attr">protectRules:</span>
<span class="hljs-attr">- match:</span>
<span class="hljs-attr">  - kind:</span> <span class="hljs-string">&quot;*&quot;</span>
<span class="hljs-attr">ignoreRules:</span>
<span class="hljs-attr">- match:</span>
<span class="hljs-attr">  - username:</span> <span class="hljs-string">&quot;system:serviceaccount:secure-ns:secure-operator&quot;</span>
<span class="hljs-attr">forceCheckRules:</span>
<span class="hljs-attr">- match:</span>
<span class="hljs-attr">  - kind:</span> <span class="hljs-string">&quot;Secret&quot;</span>
</code></pre>
<h2 id="define-allow-change-patterns">Define allow change patterns</h2>
<p>You can also set rules to allow some changes in the resource even without valid signature. For example, changes in attribute <code>data.comment1</code> in a ConfigMap <code>protected-cm</code> is allowed.</p>
<pre><code class="lang-yaml"><span class="hljs-attr">ignoreAttrs:</span>
<span class="hljs-attr">- attrs:</span>
<span class="hljs-bullet">  -</span> data.comment1
<span class="hljs-attr">  match:</span>
<span class="hljs-attr">  - name:</span> protected-cm
<span class="hljs-attr">    kind:</span> ConfigMap
</code></pre>
<h2 id="cluster-scope">Cluster scope</h2>
<p>Also for cluster-scope resources, you can use RSP to define protection rules.
The only difference between &quot;Namespaced&quot; and &quot;Cluster&quot; scope in RSP is name condition.
To avoid conflict of rules defined in multiple RSPs in different NS, a rule for Cluster scope resource must be set with concrete resource name condition.
The example below shows how to protect ClusterRoleBinding with its name.</p>
<pre><code class="lang-yaml"><span class="hljs-attr">apiVersion:</span> apis.integrityshield.io/v1alpha1
<span class="hljs-attr">kind:</span> ResourceSigningProfile
<span class="hljs-attr">metadata:</span>
<span class="hljs-attr">  name:</span> sample-rsp
<span class="hljs-attr">spec:</span>
<span class="hljs-attr">  protectRules:</span>
<span class="hljs-attr">  - match:</span>
<span class="hljs-attr">    - kind:</span> ClusterRoleBinding
<span class="hljs-attr">      name:</span> sample-crb
</code></pre>
<p>if the <code>name</code> is not specified or value for <code>name</code> has any wildcard &quot;*&quot;, then the rule does not match with any requests.</p>
<h2 id="two-types-of-rsp">Two types of RSP</h2>
<p>There are two types in RSP.</p>
<ol>
<li>per-namespace RSP</li>
<li>IShield namespace RSP
1, per-namespace RSP will be created and managed by user, and it has different lifecycle from the one of IShield itself. 
2, IShield namespace RSP, this is managed by IShield operator. It is defined in IShield CR, and operator will reconcile it.</li>
</ol>
<p>All syntax around rules are exactly same between these 2 types, but the namespace scope is different.</p>
<p>per-NS RSP, is basically used only for requests in the same namespace.
If per-NS RSP is created in <code>secure-ns</code>, then this profile is available only in <code>secure-ns</code>.</p>
<p>IShield NS RSP, is created in IShield namespace, but it will be evaluated with some other namespaced requests. 
This target namespace is defined in <code>targetNamespaceSelector</code> in RSP spec.</p>
<p>The following is an example of IShield NS RSP definition in IShield CR.
It is available for requests in <code>secure-ns</code> and <code>test-ns</code>.</p>
<pre><code class="lang-yaml"><span class="hljs-attr">spec:</span>
<span class="hljs-attr">  resourceSigningProfiles:</span>
<span class="hljs-attr">  - name:</span> multi-ns-rsp
<span class="hljs-attr">    targetNamespaceSelector:</span>
<span class="hljs-attr">      include:</span>
<span class="hljs-bullet">      -</span> secure-ns
<span class="hljs-bullet">      -</span> test-ns
<span class="hljs-attr">    protectRules:</span>
<span class="hljs-attr">    - match:</span>
<span class="hljs-attr">      - kind:</span> ConfigMap
</code></pre>
<p>for this <code>targetNamespaceSelector</code>, label selector also can be used instead of namespace list, like below.
This RSP will protect ConfgiMap in all namespaces that have <code>sampleNamespaceLabel: foo</code> or <code>sampleNamespaceLabel: bar</code> labels.</p>
<pre><code class="lang-yaml"><span class="hljs-attr">spec:</span>
<span class="hljs-attr">  resourceSigningProfiles:</span>
<span class="hljs-attr">  - name:</span> multi-ns-rsp
<span class="hljs-attr">    targetNamespaceSelector:</span>
<span class="hljs-attr">      labelSelector:</span>
<span class="hljs-attr">        matchExpressions:</span>
<span class="hljs-attr">        - key:</span> <span class="hljs-string">&quot;sampleNamespaceLabel&quot;</span>
<span class="hljs-attr">          operator:</span> In
<span class="hljs-attr">          value:</span> [<span class="hljs-string">&quot;foo&quot;</span>, <span class="hljs-string">&quot;bar&quot;</span>]
<span class="hljs-attr">    protectRules:</span>
<span class="hljs-attr">    - match:</span>
<span class="hljs-attr">      - kind:</span> ConfigMap
</code></pre>
<!-- ## Delete/Disable RSP

RSP and CRSP have two lifecycle flags `disabled` and `delete`. Those fields are `false` by default.

If `disabled` is set to `true`, the RSP (CRSP) becomes invalid and ignored when checking signature (This implies no RSP is defined in the namespace). When you set it to `false` back, the RSP will become effective again.

When you want to delete RSP, set `delete` to `true`, then IShield will delete RSP (CRSP). RSP and CRSP cannot be deleted directly, so need to set this flag when you want to delete then.

```
apiVersion: apis.integrityshield.io/v1alpha1
kind: ResourceSigningProfile
metadata:
  name: sample-rsp
  namespace: secure-ns
spec:
  disabled: false
  delete: false
``` -->
<h2 id="example-of-rsp">Example of RSP</h2>
<p>The whole RSP is represented like this. (this is example of per-namespace RSP.)</p>
<pre><code class="lang-yaml"><span class="hljs-attr">apiVersion:</span> apis.integrityshield.io/v1alpha1
<span class="hljs-attr">kind:</span> ResourceSigningProfile
<span class="hljs-attr">metadata:</span>
<span class="hljs-attr">  name:</span> sample-rsp
<span class="hljs-attr">  namespace:</span> secure-ns
<span class="hljs-attr">spec:</span>
<span class="hljs-attr">  protectRules:</span>
<span class="hljs-attr">  - match:</span>
<span class="hljs-attr">    - kind:</span> ConfigMap
<span class="hljs-attr">    - kins:</span> Secret
<span class="hljs-attr">    exclude:</span>
<span class="hljs-attr">    - kind:</span> ConfigMap
<span class="hljs-attr">      name:</span> unprotected-cm
<span class="hljs-attr">  - match:</span>
<span class="hljs-attr">    - apiGroup:</span> rbac.authorization.k8s.io
<span class="hljs-attr">  ignoreRules:</span>
<span class="hljs-attr">  - username:</span> system:serviceaccount:secure-ns:secure-operator
<span class="hljs-attr">  ignoreAttrs:</span>
<span class="hljs-attr">  - match:</span>
<span class="hljs-attr">    - name:</span> protected-cm
<span class="hljs-attr">      kind:</span> ConfigMap
<span class="hljs-attr">    attrs:</span>
<span class="hljs-bullet">    -</span> data.comment1
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="README_QUICK.html" class="navigation navigation-prev " aria-label="Previous page: Quick Start">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="README_SIGNER_CONFIG.html" class="navigation navigation-next " aria-label="Next page: Signer Configuration">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Define Protected Resources","level":"1.4","depth":1,"next":{"title":"Signer Configuration","level":"1.5","depth":1,"path":"README_SIGNER_CONFIG.md","ref":"README_SIGNER_CONFIG.md","articles":[]},"previous":{"title":"Quick Start","level":"1.3","depth":1,"path":"README_QUICK.md","ref":"README_QUICK.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-sharing","hide-published-with"],"root":".","styles":{"website":"style.css"},"pluginsConfig":{"hide-published-with":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"readme.md","glossary":"GLOSSARY.md","summary":"summary.md"},"variables":{},"gitbook":"*"},"file":{"path":"README_FOR_RESOURCE_SIGNING_PROFILE.md","mtime":"2021-03-08T01:40:49.206Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-03-11T01:59:21.275Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-hide-published-with/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

